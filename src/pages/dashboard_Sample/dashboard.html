<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="dashboard_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>


<body>

    <div class = "mainWrapper">
        <img class = "Backgroundimg" src = "..\..\components\Images\White Background Green.png">

        <div class = "sideBar">
            <div class = "userInfoSideBar">
                <div class = "userPic"></div>
                <p class = "userName"></p>
                <p class = "userType"></p>
                <p class = "votingStatusTitle">Voting Status: </p>
                <p class = "userVotingStatus"></p>
            </div>
            <div class="menuSelect">
                <a href="#dashboard" class="menuTab">
                    <img src="..\..\components\Images\Dashboard Logo.png" alt="DashboardLogo" class="menuTabLogo">
                    <p class="menuTabTitle">Dashboard</p>
                </a>
                <a href="#vote" class="menuTab">
                    <img src="..\..\components\Images\Vote Logo.png" alt="VoteLogo" class="menuTabLogo">
                    <p class="menuTabTitle">Vote</p>
                </a>
                <a href="#settings" class="menuTab">
                    <img src="..\..\components\Images\Settings Logo.png" alt="SettingsLogo" class="menuTabLogo">
                    <p class="menuTabTitle">Settings</p>
                </a>
                <a href="#" class="menuTab" id="logoutLink">
                    <img src="..\..\components\Images\Logout Logo.png" alt="LogoutLogo" class="menuTabLogo">
                    <p class="menuTabTitle">Log out</p>
                </a>
            </div>
        </div>
        
    <section id="dashboard" class="content">
        <div class = "midBar">
            <div class="ongoingElecBox">
                <div class="midBoxHeader">
                    <p class="midBoxText">Ongoing Elections</p>
                </div>
                <button class="newsAndUpdatesButton">News and Updates</button>
            </div>

            <div class = "liveResultsBox">
                <div class = "midBoxHeader">
                    <p class = midBoxText>Live Results</p>
                </div>
                <button class = "electionResultsButton">Election Results</button>
            </div>

            <div class = "electionTimeBox">
                <div class = "midBoxHeader">
                    <p class = midBoxText>Election Timeline</p>
                </div>
            </div>
        </div>
    </section>

    <section id="vote" class="content">
        <div class="vote-container">
            <h1>Cast Your Vote</h1>
    
            <div class="party-lists">
                <h2>Party Lists</h2>
                <div id="party-list-container"></div>
            </div>
    
            <div class="candidate-list">
                <h2>Candidate List</h2>
                <div id="candidate-list-container"></div>
            </div>
    
            <div class="vote-button-container">
                <button id="cast-vote-button">Cast Vote</button>
            </div>
        </div>
    </section>

    <section id="settings" class="content">
        <div class="allsettings">
            <div class="accBox">
                <h1>Account Information</h1>

                <div class="accdet">
                    <label for="name">Name</label>
                    <input type="text" id="name" value="John Doe" readonly>
                </div>
                <div class="accdet">
                    <label for="idNumber">ID Number</label>
                    <input type="text" id="idNumber" value="" readonly>
                </div>
                <div class="accdet">
                    <label for="status">Status</label>
                    <input type="text" id="status" value="" readonly>
                </div>
                <div class="accdet">
                    <label for="yearLevel">Year Level</label>
                    <input type="text" id="yearLevel" value="" readonly>
                </div>
                <div class="accdet">
                    <label for="department">Department</label>
                    <input type="text" id="department" value="" readonly>
                </div>
                <div class="accdet">
                    <label for="course">Course</label>
                    <input type="text" id="course" value="" readonly>
                </div>
                    <button class="btn">Change Password</button>
                    <button class="btn">Change Profile Picture</button>
            </div>

            <div class="extras">
                <a href="..\privacypolicy\privacypolicy.html">
                    <button class="btn">Privacy Policy</button>
                  </a>
                  <a href="..\termsofservice\TermsOfService.html">
                    <button class="btn">Terms Of Service</button>
                  </a>
            </div>

    </section>

        <img class = "USClogo" src = "..\..\components\Images\Right USC Logo.png">
    </div>


    <footer class = "FooterBox">
        <div class = "footerContainer"></div>
            <img class = "FooterLogo" src = "..\..\components\Images\LogoCCC.png">
            <p class = "SiteName">Carolinian Council Choice</p>
            <p class = "Copyright">Â© 2024 Web 1</p>
        
            <div class="socialIcons">
                    <a href=""><i class="fa-brands fa-facebook"></i></a>
                    <a href=""><i class="fa-brands fa-instagram"></i></a>
                    <a href=""><i class="fa-brands fa-twitter"></i></a>
                    <a href=""><i class="fa-brands fa-youtube"></i></a>
            </div>
        </div>
    </footer>


    <script type="text/javascript">
        window.addEventListener('load', function() {
            console.log('Page Loaded');
            const navLinks = document.querySelectorAll('.navBar a');
            const currentPage = window.location.href;
            const homeLink = document.querySelector('.navBar a[href="LandingPage.html"]');
            const path = window.location.pathname.replace(/^\//, '');
            const isLandingPage = path === '' || path.endsWith('LandingPage.html');

            navLinks.forEach(link => {
                const linkHref = link.getAttribute('href');
                link.classList.remove('current-page');
                if (isLandingPage && link === homeLink) {
                    link.classList.add('current-page');
                } else if (currentPage.includes(linkHref)) {
                    link.classList.add('current-page');
                }
            });
        });

        const { createClient } = supabase;
        const supabaseUrl = 'https://qbdvzhavzxgjdgctnzoe.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZHZ6aGF2enhnamRnY3Ruem9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTY3OTM1MjIsImV4cCI6MjAzMjM2OTUyMn0.NyzChModofn6DKXkbQ4GU-TPdDccvxAtsuKuj9puK4c';
        const connection = createClient(supabaseUrl, supabaseKey);

        window.addEventListener('load', async () => {
            console.log('Page Loaded');

            // Get the current user's email from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const uscEmail = urlParams.get('uscEmail');

            console.log(uscEmail);

            try {
                // Fetch the user's information from the user_table
                const { data: user, error } = await connection.from('user_table')
                .select('firstName, lastName, userType, voteStatus')
                .eq('uscEmail', uscEmail)
                .single();

                if (error) {
                console.error(error);
                alert('Error fetching user information. Please try again later.');
                } else {
                // Update the userInfoSideBar elements
                document.querySelector('.userName').textContent = `${user.firstName} ${user.lastName}`;
                document.querySelector('.userType').textContent = user.userType;
                document.querySelector('.userVotingStatus').textContent = user.voteStatus;
                }
            } catch (error) {
                console.error(error);
                alert('An error occurred while fetching user information. Please try again later.');
            }
            });

            window.addEventListener('load', function() {
                console.log('Page Loaded');
                const navLinks = document.querySelectorAll('.navBar a');
                const currentPage = window.location.href;
                const homeLink = document.querySelector('.navBar a[href="LandingPage.html"]');
                const path = window.location.pathname.replace(/^\//, '');
                const isLandingPage = path === '' || path.endsWith('LandingPage.html');

                navLinks.forEach(link => {
                    const linkHref = link.getAttribute('href');
                    link.classList.remove('current-page');
                    if (isLandingPage && link === homeLink) {
                        link.classList.add('current-page');
                    } else if (currentPage.includes(linkHref)) {
                        link.classList.add('current-page');
                    }
                });

                setupLogout(); // Call the setupLogout function
            });


            function setupLogout() {
                const logoutLink = document.getElementById('logoutLink');
                if (logoutLink) {
                    logoutLink.addEventListener('click', handleLogout);
                }
            }

            async function handleLogout(e) {
                e.preventDefault(); // Prevent the default link behavior

                // Get the current user's email from the URL
                const urlParams = new URLSearchParams(window.location.search);
                const uscEmail = urlParams.get('uscEmail');

                try {
                    // Update the authStatus in the user_table
                    const { data, error } = await connection.from('user_table')
                    .update({ authStatus: 'Off' })
                    .eq('uscEmail', uscEmail);

                    if (error) {
                    console.error(error);
                    alert('Error updating auth status. Please try again later.');
                    } else {
                    // Redirect to the login page
                    alert("You have been successfully Signed out!");
                    window.location.href = '../loginpage/login.html';
                    }
                } catch (error) {
                    console.error(error);
                    alert('An error occurred while updating auth status. Please try again later.');
                }
            }

            async function fetchPartyLists() {
    try {
        console.log('Fetching party lists...');
        const { data, error } = await connection.from('parties').select('*');
        if (error) throw error;

        console.log('Party data:', data);

        // Clear the party-list-container before populating it
        const partyListContainer = document.getElementById('party-list-container');
        partyListContainer.innerHTML = '';

        // Populate the party-list-container with party names
        data.forEach(party => {
            const partyElement = document.createElement('div');
            partyElement.textContent = party.partyname;
            partyElement.addEventListener('click', () => {
                selectedPartyId = party.partyid;
                fetchCandidates(party.partyid);
            });
            partyListContainer.appendChild(partyElement);
        });

        console.log('Party lists fetched and displayed successfully.');
    } catch (error) {
        console.error('Error fetching party lists:', error);
        alert('Error fetching party lists. Please try again later.');
    }
}

async function fetchCandidates() {
            try {
                // Fetch candidates with their associated positions and party lists
                const { data: candidates, error } = await connection
                    .from('candidates')
                    .select(`
                        firstName,
                        lastName,
                        candidateDescription,
                        positions (
                            position_name
                        ),
                        parties (
                            partyname
                        )
                    `);

                if (error) throw error;

                // Update the candidate container with the fetched data
                const candidateContainer = document.getElementById('candidate-list-container');
                candidateContainer.innerHTML = '';
                candidates.forEach(candidate => {
                    const candidateElement = document.createElement('div');
                    candidateElement.innerHTML = `
                        <div>
                            <span>${candidate.firstName} ${candidate.lastName}</span>
                            <span> - ${candidate.positions.position_name}</span>
                            <span> (Party: ${candidate.parties.partyname})</span>
                        </div>
                        <p>${candidate.candidateDescription}</p>
                    `;
                    candidateContainer.appendChild(candidateElement);
                });
            } catch (error) {
                console.error('Error fetching candidates:', error);
                alert('Error fetching candidates. Please try again later.');
            }
        }
// Select a candidate
function selectCandidate(candidateId) {
    // Update the selected candidate ID
    selectedCandidateId = candidateId;

    // Highlight the selected candidate
    const candidateElements = document.querySelectorAll('#candidate-list-container > div');
    candidateElements.forEach(element => {
        element.classList.remove('selected');
    });
    const selectedCandidateElement = document.querySelector(`#candidate-list-container > div:nth-child(${candidateId})`);
    selectedCandidateElement.classList.add('selected');
}

// Cast the vote
async function castVote() {
    try {
        // Check if a party and candidate are selected
        if (selectedPartyId === null || selectedCandidateId === null) {
            alert('Please select a party and a candidate to cast your vote.');
            return;
        }

        // Get the current user's email from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const uscEmail = urlParams.get('uscEmail');

        // Insert the vote into the database
        const { data, error } = await connection.from('votes').insert({
            uscEmail: uscEmail,
            partyid: selectedPartyId,
            candidateid: selectedCandidateId
        });

        if (error) throw error;

        alert('Your vote has been cast successfully!');
    } catch (error) {
        console.error('Error casting vote:', error);
        alert('An error occurred while casting your vote. Please try again later.');
    }
}

// Run the functions when the page is loaded
window.addEventListener("load", fetchPartyLists);
document.addEventListener('DOMContentLoaded', fetchCandidates);
    </script>
</body>
</html>
